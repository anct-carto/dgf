<!DOCTYPE html>
<html>

<head>

	<!-- Développement : service cartographie du CGET -->

    <meta charset="utf-8" />
    <title>Dotations</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="shortcut icon" type="image/png" href="img/logo.png"/>
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
	<link rel="stylesheet" href="src/leaflet-search.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.3/dist/leaflet.css" />
    <link rel="stylesheet" href="src/leaflet-sidebar.css" />
	<link rel="stylesheet" href="style.css" />
	
</head>

<body>

    <div id="sidebar" class="sidebar collapsed">
        <div class="sidebar-tabs" id="barre-verticale">
            <ul role="tablist">
                <li><a href="#home" role="tab" class="tabs" id="logo"><i class="fas fa-home"></i></a></li>
				<!--<li><a href="https://cartotheque.cget.gouv.fr/cartes?filters%5Bquery%5D=&filters%5Bserie%5D%5BSerie%5D%5B0%5D=field.Serie%3Ar%22Grand+D%C3%A9bat+National%22&current_page=1&category=&page_size=20&query=" role="tab"  class="tabs" target="_blank" title="Cartothèque du CGET"><i class="fas fa-map"></i></a></li>-->
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1>Dotations de fonctionnement
				<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
				
				<div class="presentation" id="defaut">
					
					<div>
						<p><strong>Carte interactive des dotations de fonctionnement</strong></p>
						<p><i>Cliquez dans la légende pour filtrer les informations, ou recherchez directement votre département ou votre commune.</i></p>
						<p>Informations sur les dotations de fonctionnement attribuée par l'État aux communes, aux EPCI et aux départements</p>
						</div>
						
					<div class="boutons">
					<div class="bouton" id="bouton1"><img src="img/picto_1b.png" style="vertical-align:middle; width:20px;padding:0px 10px;"  />Voir les départements</div>
					<div class="bouton" id="bouton2"><img src="img/picto_2b.png" style="vertical-align:middle; width:20px;padding:0px 10px;"  />Voir les communes</div>
					<div class="bouton" id="bouton3"><img src="img/picto_3b.png" style="vertical-align:middle; width:20px;padding:0px 10px;"  />Voir les EPCI</div>
					</div>
						
				<div id="sources">
					<img src="img/cget.png" alt="" width="60%"/>
					</div>
				</div>

				<div class="ol-popup" id="popup">
					<div id="titre"></div>
					<div id="N1EVO"></div>
					<div id="N2MONTANT"></div>
					<div id="N3PART_PER"></div>
					<div id="N4PART_DGF"></div>
				</div>
					
            </div>

        </div>
    </div>

	<div id="mapid"></div>

    <script src="https://unpkg.com/leaflet@1.3.3/dist/leaflet.js"></script>
	<script src="src/leaflet-search.js"></script>
    <script src="https://turbo87.github.io/sidebar-v2/js/leaflet-sidebar.js"></script>
	<script type="text/javascript" src="data/masque.js"></script>
	<!--<script type="text/javascript" src="data/toutes_couches.js"></script>-->
	<script type="text/javascript" src="data/geoData.js"></script>
	<script type="text/javascript" src="data/cercles_drom.js"></script>
	
    <script>
		
			
		// Création de la carte
		var map = L.map('mapid', {maxZoom:11, minZoom:6 })
		.setView([46.5, 0.5], 6);
		map.zoomControl.setPosition('topright');
		map.attributionControl.addAttribution('<a href="https://cartotheque.cget.gouv.fr/cartes" style="text-decoration:none;" target="_blank ">CGET</a>');
		
		var GeoportailFrance_parcels = L.tileLayer('https://wxs.ign.fr/{apikey}/geoportail/wmts?REQUEST=GetTile&SERVICE=WMTS&VERSION=1.0.0&STYLE={style}&TILEMATRIXSET=PM&FORMAT={format}&LAYER=CADASTRALPARCELS.PARCELS&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}', {
		attribution: '',
		apikey: 'choisirgeoportail',
		format: 'image/png',
		style: 'bdparcellaire'
		});
		
		//GeoportailFrance_parcels.addTo(map);
		
		//Ajout des couches du fond de carte
		Cache = L.geoJSON(JS_masque, {color: "#154463", weight: 0, opacity: 1, fillOpacity: 1}).addTo(map);
		Cercles_drom = L.geoJSON(JS_drom, {color: "#ffffff", weight: 0.5, opacity: 0.7, fillOpacity: 0}).addTo(map);
		
		commune = L.geoJSON(JS_todo, {
			filter: function(feature, layer) {return feature.properties.Type == "com";},
			style : {weight: 0.8, color: "#3e62a4", opacity: 1, fillOpacity: 1, fillColor:"#00bdce"},
			onEachFeature: function(feature, layer) {
					layer.bindTooltip(feature.properties.libgeo, {className: 'Tooltips'});
					layer.on('click', function(e) {
						popup(feature.properties);
						epciCible(e.target._latlngs);
						preventDefault(e);
						})
					}
		});
		
		/*Contour_Regions = L.geoJSON(JS_todo, {
			filter: function(feature, layer) {return feature.properties.layer == "region";},
			style: {interactive: false, color: "#003b5e", weight: 1, opacity: 1, fillOpacity: 0}
		}).addTo(map);*/
		
		departement = L.geoJSON(JS_todo, {
			filter: function(feature, layer) {return feature.properties.Type == "dep";},
			style: {weight: 0.8, color: "#3e62a4", opacity: 1, fillOpacity: 1, fillColor:"#00bdce"},
			onEachFeature: function(feature, layer) {
					layer.bindTooltip(feature.properties.libgeo, {className: 'Tooltips'});
					layer.on('click', function(e) {
						popup(feature.properties);
						epciCible(e.target._latlngs);
						preventDefault(e);
						})
					}
		}).addTo(map);
		
		//Ajout de la sidebar
		var sidebar = L.control.sidebar('sidebar').addTo(map);
		
		
		//Action au clic sur un marker
		function popup(e) {
			
			if (document.getElementById('sidebar').classList.contains('collapsed')){
				sidebar.open('home');
				}
			
			//Remplissage de la popup
			document.getElementById('popup').style.display = "block";
			document.getElementById('defaut').style.display = "none";
			
			document.getElementById('titre').innerHTML = "<h1 style='#ffffff'>"+e.libgeo+"</h1>";
			document.getElementById('N1EVO').innerHTML = "<p>Évolution de la dotation forfaitaire 2017/2018 : "+e.N1EVO+"</p>";
			document.getElementById('N2MONTANT').innerHTML = "<p>Montant dotation globale de fonctionnement (part forfaitaire + part péréquation) : "+e.N2MONTANT+"</p>";
			document.getElementById('N3PART_PER').innerHTML = "<p>Part péréquation/DGF : "+e.N3PART_PER+"</p>";
			document.getElementById('N4PART_DGF').innerHTML = "<p>Part DGF/Recettes réelles de fonctionnement : "+e.N4PART_DGF+"</p>";
		}
		
		//Indiquer epci sélectionné
		var epciCib;
		function epciCible(e) {
			if(epciCib) {map.removeLayer(epciCib);}
			epciCib = new L.polygon(e, {weight:0.4, fillOpacity: 0.9, Color:"#b51917", fillColor:"#b51917"});
			epciCib.addTo(map);
		}
		
		function clickMap () {
			if(epciCib) {map.removeLayer(epciCib);}
			//fermer ou ouvrir la sidebar
			if (document.getElementById('sidebar').classList.contains('collapsed')) {
				sidebar.open('home');
			}
			else {
				sidebar.close();
			}
			//remettre le texte d'intro
			document.getElementById('popup').style.display = "none";
			document.getElementById('defaut').style.display = "block";
			}
			
		//Events au clic sur la carte
		map.on('click', clickMap);
		
		//Event au clic sur "home"
		document.getElementById("logo").addEventListener("click", function(event){
			
			sidebar.open('home');
			//remettre le texte d'intro
			document.getElementById('popup').style.display = "none";
			document.getElementById('defaut').style.display = "block";
			event.stopPropagation();
		});
		
		//Event au clic sur la barre verticale
		document.getElementById("barre-verticale").addEventListener("click", function(event){
			
			if (document.getElementById('sidebar').classList.contains('collapsed')) {
				sidebar.open('home');
			}
			else {
				sidebar.close();
			}
		});
		
		//Boutons en légende
		document.getElementById("bouton1").addEventListener("click", function(event){
			event.stopPropagation();
			document.getElementById('bouton1').setAttribute("class", "bouton_on");
			document.getElementById('bouton2').setAttribute("class", "bouton");
			document.getElementById('bouton3').setAttribute("class", "bouton");
			if (map.hasLayer(commune)) {map.removeLayer(commune);};
			//if (map.hasLayer(pointTop)) {map.removeLayer(pointTop);};
			if (map.hasLayer(departement)==false) {map.addLayer(departement); }
		});	

		document.getElementById("bouton2").addEventListener("click", function(event){
			event.stopPropagation();
			document.getElementById('bouton1').setAttribute("class", "bouton");
			document.getElementById('bouton2').setAttribute("class", "bouton_on");
			document.getElementById('bouton3').setAttribute("class", "bouton");
			if (map.hasLayer(departement)) {map.removeLayer(departement);};
			//if (map.hasLayer(pointTop)) {map.removeLayer(pointTop);};
			if (map.hasLayer(commune)==false) {map.addLayer(commune); }
		});	
		
		/*document.getElementById("bouton3").addEventListener("click", function(event){
			event.stopPropagation();
			document.getElementById('bouton1').setAttribute("class", "bouton");
			document.getElementById('bouton2').setAttribute("class", "bouton");
			document.getElementById('bouton3').setAttribute("class", "bouton_on");
			if (map.hasLayer(pointMedium)) {map.removeLayer(pointMedium);};
			if (map.hasLayer(pointBottom)) {map.removeLayer(pointBottom);};
			if (map.hasLayer(pointTop)==false) {map.addLayer(pointTop); }
		});	*/
		
		
		
		//Barre de recherche
		var Recherche = L.layerGroup([commune]);
		
		var searchControl = new L.control.search({
			layer: Recherche,
			initial: false,
			position:'topright',
			propertyName: 'libgeo',
			marker: false,
			moveToLocation: function(latlng, title, map) {
				var zoom = map.getBoundsZoom(latlng.layer.getBounds());
				map.setView(latlng, zoom-1, {
				  "animate": true,
				  "pan": {"duration": 10} // access the zoom
				});
			}
		})
		
		searchControl.on('search:locationfound', function(e) {
			if(epciCib) {map.removeLayer(epciCib);}
			epciCible(e.layer._latlngs);
			popup(e.layer.feature.properties);
		});
		
		map.addControl( searchControl );
		
		sidebar.open('home');
		
		map.removeLayer(commune);

   </script>
	
</body>



</html>
