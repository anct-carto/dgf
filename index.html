<!DOCTYPE html>
<html>

<head>

	<!-- Développement : service cartographie du CGET -->

    <meta charset="utf-8" />
    <title>DGF</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="shortcut icon" type="image/png" href="img/logo.png"/>
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
	<link rel="stylesheet" href="src/leaflet-search.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.3/dist/leaflet.css" />
    <link rel="stylesheet" href="src/leaflet-sidebar.css" />
	<link href="https://fonts.googleapis.com/css?family=Asap:400,400i,500,500i,600,600i,700,700i|Crimson+Text:400,400i,600,600i,700,700i" rel="stylesheet">
	<link rel="stylesheet" href="style.css" />
	
</head>

<body>

    <div id="sidebar" class="sidebar collapsed">
        <div class="sidebar-tabs" id="barre-verticale">
            <ul role="tablist" >
                <li><a href="#home" role="tab" id="logo" title="Retour à l'accueil" class="onglets"><i style="vertical-align:middle;" class="fas fa-home"></i></a></li>
				<li><a href="#home" role="tab" class="onglets" id="logo_dep" title="Départements"><img src="img/blanktabdep.png"/></a></li>
				<li><a href="#home" role="tab" class="onglets" id="logo_epci" title="Intercommunalités"><img src="img/blanktabepci.png"/></a></li>
				<li><a href="#home" role="tab" class="onglets" id="logo_com" title="Communes"><img src="img/blanktabcom.png"/></a></li>
				<li><a href="img/cartes_dgf.pdf" role="tab" target="_blank" title="Télécharger les cartes" class="onglets"><i style="vertical-align:middle;" class="fa fa-download"></i></a></li>
			</ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1>L'État dans les territoires
				<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
				
				<div class="presentation" id="defaut">
					
					<div>
						<h2>Répartition de la dotation globale de fonctionnement (DGF) en 2019</h2>
						<p style="color:#f26664;">26,94 milliards d'euros de dotation globale de fonctionnement pour les communes, les intercommunalités et les conseils départementaux</p>
						<p>En 2019, le montant de la dotation globale de fonctionnement (DGF) est <span style="color:white;">stabilisé</span> pour la 2ème année consécutive, et après 4 années de baisse continue entre 2014 et 2017.</p>
						<p>Principale dotation de l'État aux collectivités locales, elle représente <span style="color:white;">xx,xx%</span> de leurs recettes réelles de fonctionnement constituées majoritairement du produit des impôts locaux (taxe d’habitation, taxes foncières, cotisation économique territoriale, …).</p>
						<p>Au sein de la DGF, l’État consacre <span style="color:white;">7,7 milliards d’euros</span> à la solidarité en faveur collectivités les plus en difficulté via notamment la dotation de solidarité urbaine ou la dotation de solidarité rurale.</p>
						<p>La part dédiée à la solidarité territoriale augmente cette année de <span style="color:white;">190 millions d’euros</span>.
					</div>
					
					<div class="boutons">
						<h2>Accédez aux informations relatives à la DGF 2019 pour votre commune, intercommunalité ou département&nbsp;:</h2>
						<p class="indicateur"><img src="img/bullet.png" style="vertical-align:middle; width:15px;padding:0px 00px;"  />Montant de la DGF en 2019</p>
						<p class="indicateur"><img src="img/bullet.png" style="vertical-align:middle; width:15px;padding:0px 00px;"  />Montant de la DGF par habitant en 2019</p>
						<p class="indicateur bouton_on" id="indicateur1" title="voir la carte"><img src="img/bullet.png" style="vertical-align:middle; width:15px;padding:0px 0px;"  />Variation de la DGF entre 2018 et 2019</p>
						<p class="indicateur"><img src="img/bullet.png" style="vertical-align:middle; width:15px;padding:0px 00px;"  />Part de la DGF dans les recettes réelles de fonctionnement en 2019</p>
						<p class="indicateur bouton" id="indicateur2" title="voir la carte"><img src="img/bullet.png" style="vertical-align:middle; width:15px;padding:0px 00px;"  />Variation de la DGF entre 2018 et 2019 en pourcentage des recettes réelles de fonctionnement</p>
						<p class="indicateur"><img src="img/bullet.png" style="vertical-align:middle; width:15px;padding:0px 00px;"  />Part de la solidarité territoriale dans la DGF en 2019</p>
						</br>
						<div class="bouton bouton_dep" ><img src="img/fleche.png" style="vertical-align:middle; width:20px;padding:0px 10px;" />Voir les conseils départementaux</div>
						<div class="bouton bouton_epci" ><img src="img/fleche.png" style="vertical-align:middle; width:20px;padding:0px 10px;" />Voir les intercommunalités</div>
						<div class="bouton bouton_com" ><img src="img/fleche.png" style="vertical-align:middle; width:20px;padding:0px 10px;" />Rechercher une commune</div>
						</br>
						
						
					</div>
						
					<div id="sources" style="width:70%;">
						<p><i>Sources&nbsp;: <a href="http://www.dotations-dgcl.interieur.gouv.fr/consultation/accueil.php" target="_blank">Direction générale des collectivités locales (DGCL) </a>• Réalisation&nbsp;: <a href="https://cartotheque.cget.gouv.fr/cartes?filters%5Bquery%5D=interactif&current_page=1&category=&page_size=20" target="_blank">CGET service cartographie</a></i><p>
						<p><img src="img/cget.png" style="vertical-align:middle; width:100%;"/></p>
						<p><img src="img/dgcl.png" style="vertical-align:middle; width:100%;"/></p>
					</div>
					
				</div>
				
				
				<div class="presentation" id="onglet_departement">
					<h2 style='color:#f26664'>Les conseils départementaux</h2>
					<p>La DGF des conseils départementaux s’élève à <span style="color:white;">8,6 milliards d’euros en 2019</span>. Elle est stable par rapport à 2018.</p>
					<p>La DGF représente en moyenne <span style="color:white;">11,81% (2018)</span> des recettes réelles de fonctionnement des conseils départementaux. La part de la DGF est supérieure à la moyenne dans <span style="color:white;">71 (2018)</span> conseils départementaux.</p>
					<p>La DGF augmente pour <span style="color:white;">49 (2018)</span> conseils départementaux. Les crédits supplémentaires représentent en moyenne <span style="color:white;">0,07% (chiffre 2018)</span> des recettes réelles de fonctionnement des conseils départementaux concernés.</p>
					<p>Elle diminue pour <span style="color:white;">51 (2018)</span> conseils départementaux. Cette diminution représente en moyenne <span style="color:white;">0,06% (2018)</span> des recettes réelles de fonctionnement des conseils départementaux concernés.</p>
					<p>En dehors des évolutions de population, les modifications de DGF sont principalement dues au choix du gouvernement de renforcer la solidarité avec les conseils départementaux qui le justifient le plus. Ces transferts de solidarité représentent <span style="color:white;">17,35% (2018)</span> de la DGF des conseils départementaux. La part de la solidarité territoriale est supérieure à la moyenne pour <span style="color:white;">64 (2018)</span> conseils départementaux.</p>
					<div class="bas">
						<div class="bouton switch_indicateur" title="indicateur1"><img src='img/fleche.png' style='vertical-align:middle; width:20px;padding:0px 10px;' />Voir la variation de la DGF entre 2018 et 2019 en pourcentage des recettes réelles de fonctionnement</div>
						<div class="bouton bouton_epci"><img src="img/fleche.png" style="vertical-align:middle; width:20px;padding:0px 10px;" />Voir les intercommunalités</div>
						<div class="bouton bouton_com" ><img src="img/fleche.png" style="vertical-align:middle; width:20px;padding:0px 10px;" />Rechercher une commune</div>
						<div class="bouton retour"><img src='img/fleche.png' style='vertical-align:middle; width:20px;padding:0px 10px;'  />Retour</div>
					</div>
				</div>
				
				<div class="presentation" id="onglet_commune">
					<h2 style='color:#f26664'>Les communes</h2>
					<p style="font-weight:bold;height:21px;color:white;">Rechercher une commune ou double-cliquer sur l'intercommunalité correspondante<div id="boiteRecherche"></div></p>
					<br/><br/>
					<p>La DGF des communes s’élève à <span style="color:white;">XX milliards d’euros en 2019.</p>
					<p>La DGF représente en moyenne <span style="color:white;">14,56% (2018)</span> des recettes réelles de fonctionnement des communes. La part de la DGF est supérieure à la moyenne pour <span style="color:white;">26 120 (2018)</span> communes.</p>
					<p>La DGF augmente pour <span style="color:white;">18 312 (2018)</span> communes. Les crédits supplémentaires représentent en moyenne <span style="color:white;">0,63%</span> des recettes réelles de fonctionnement des communes concernées. Elle est stable pour <span style="color:white;">17 (chiffre 2018) communes</span>.</p>
					<p>Elle diminue pour <span style="color:white;">16 743 (2018)</span> communes. Cette diminution représente en moyenne <span style="color:white;">0,52% (2018)</span> des recettes réelles de fonctionnement des communes concernées.</p>
					<p>En dehors des évolutions de population, les modifications de DGF sont principalement dues au choix du gouvernement de renforcer la solidarité avec les communes qui le justifient le plus. Ces transferts de solidarité représentent <span style="color:white;">38,29% (2018)</span> de la DGF des communes. La part de la solidarité territoriale est supérieure à la moyenne pour <span style="color:white;">13 355 (2018) communes.</p>
					
					<div class="bas retour bouton"><img src='img/fleche.png' style='vertical-align:middle; width:20px;padding:0px 10px;'  />Retour</div>
				</div>
				
				<div class="presentation" id="onglet_epci">
					<h2 style='color:#f26664'>Les intercommunalités</h2>
					<p>La DGF des intercommunalités s’élève à <span style="color:white;">XX milliards d’euros en 2019</p>
					<p>La DGF représente en moyenne <span style="color:white;">15,20% (2018)</span> des recettes réelles de fonctionnement des intercommunalités. La part de la DGF est supérieure à la moyenne dans <span style="color:white;">273 (2018)</span> intercommunalités.</p>
					<p>La DGF augmente pour <span style="color:white;">226 (2018)</span> intercommunalités. Les crédits supplémentaires représentent en moyenne <span style="color:white;">1,17% (2018)</span> des recettes réelles de fonctionnement des intercommunalités concernés.</p>
					<p>Elle diminue pour <span style="color:white;">1 026 (2018)</span> intercommunalités. Cette diminution représente en moyenne <span style="color:white;">0,32% (2018)</span> des recettes réelles de fonctionnement des intercommunalités concernés.</p>
					<p>En dehors des évolutions de population, les modifications de DGF sont principalement dues au choix du gouvernement de renforcer la solidarité avec les intercommunalités qui le justifient le plus. Ces transferts de solidarité représentent <span style="color:white;">22,91% (2018)</span> de la DGF des intercommunalités. La part de la solidarité territoriale est supérieure à la moyenne pour <span style="color:white;">852 (2018) intercommunalités.</p>
					<div class="bas">
						<div class="bouton switch_indicateur" title="indicateur1"><img src='img/fleche.png' style='vertical-align:middle; width:20px;padding:0px 10px;' />Voir la variation de la DGF entre 2018 et 2019 en pourcentage des recettes réelles de fonctionnement</div>
						<div class="bouton bouton_dep"><img src="img/fleche.png" style="vertical-align:middle; width:20px;padding:0px 10px;" />Voir les conseil départementaux</div>
						<div class="bouton bouton_com" ><img src="img/fleche.png" style="vertical-align:middle; width:20px;padding:0px 10px;" />Rechercher une commune</div>
						<div class="bouton retour"><img src='img/fleche.png' style='vertical-align:middle; width:20px;padding:0px 10px;'  />Retour</div>
					</div>
				</div>

				<div class="divTable" id="popup">
					<div id="titre"></div>
					<div class="divTableBody">
						<div class="divTableCell">
								<div class="divTableRow"><h3>Montant de la dotation globale de fonctionnement en 2019&nbsp;:</h3></div>
								<div class="divTableRow chiffre" id="N2MONTANT"></div>
								<div class="divTableRow ptichiffre" id="N2_DP"></div>
						</div>
						<div class="divTableCell">
								<div class="divTableRow"><h3>Montant de la DGF par habitant en 2019&nbsp;:</h3></div>
								<div class="divTableRow chiffre" id="N3DGFHAB"></div>
						</div>
						<div class="divTableCell">
								<div class="divTableRow"><h3>Variation de la DGF entre 2018 et 2019&nbsp;:</h3></div>
								<div class="divTableRow chiffre" id="N1EVO"></div>
						</div>
						<div class="divTableCell">
								<div class="divTableRow"><h3>Part de la DGF dans les recettes réelles de fonctionnement&nbsp;:</h3></div>
								<div class="divTableRow chiffre" id="N6PCTRRF"></div>
						</div>
						<div class="divTableCell">
								<div class="divTableRow"><h3>Variation de la DGF entre 2018 et 2019 par rapport aux recettes réelles de fonctionnement (en %)&nbsp;:</h3></div>
								<div class="divTableRow chiffre" id="N4VARRRF"></div>
								<div class="divTableRow description" id="N4info"></div>
						</div>
						<div class="divTableCell">
								<div class="divTableRow"><h3>Part de la solidarité territoriale dans la DGF 2019 (en %)&nbsp;:</h3></div>
								<div class="divTableRow chiffre" id="N5PEREK"></div>
						</div>
					</div>
					<div id="lien" style="margin-top:10px; text-align:center"></div>
					<div class="retour bouton"><img src='img/fleche.png' style='vertical-align:middle; width:20px;padding:0px 10px;'  />Retour</div>
				</div>
					
            </div>

        </div>
    </div>

	<div id="mapid"></div>

    <script src="https://unpkg.com/leaflet@1.3.3/dist/leaflet.js"></script>
	<script src="src/leaflet-search.js"></script>
    <script src="https://turbo87.github.io/sidebar-v2/js/leaflet-sidebar.js"></script>
	<script type="text/javascript" src="data/masque.js"></script>
	<script type="text/javascript" src="data/geoData.js"></script>
	<script type="text/javascript" src="data/cercles_drom.js"></script>
	
    <script>
		
		//Définition des variables globales
		var maillage = "département";
		var indicateur = "indicateur1";
			
		// Création de la carte
		var map = L.map('mapid', {maxZoom:11, minZoom:5 })
		.setView([46.5, -1.8], 6);
		map.zoomControl.setPosition('topright');
		map.attributionControl.addAttribution('<a href="https://cartotheque.cget.gouv.fr/cartes" style="text-decoration:none;" target="_blank ">CGET</a>');
		
		var GeoportailFrance_parcels = L.tileLayer('https://wxs.ign.fr/{apikey}/geoportail/wmts?REQUEST=GetTile&SERVICE=WMTS&VERSION=1.0.0&STYLE={style}&TILEMATRIXSET=PM&FORMAT={format}&LAYER=CADASTRALPARCELS.PARCELS&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}', {
		attribution: '',
		apikey: 'choisirgeoportail',
		format: 'image/png',
		style: 'bdparcellaire'
		});
		
		//GeoportailFrance_parcels.addTo(map);
		
		//Ajout des couches du fond de carte
		Cache = L.geoJSON(JS_masque, {color: "#7183ab", weight: 0, opacity: 1, fillOpacity: 1}).addTo(map);
		Cercles_drom = L.geoJSON(JS_drom, {color: "#ffffff", weight: 0.5, opacity: 0.7, fillOpacity: 0}).addTo(map);
		
		function getColor1(a,d) { //N1_EVO1718
			if(a=="département") {
				return 	d > 0.005 ? '#f4661d' : //augmentation
				d <= -0.005  ? '#fbd9c7' : //diminution
				d <= 0.005 ? '#f69564' : //stabilité
				'grey' ;
			}
			else {
				return 	d > 0.02 ? '#f4661d' : //augmentation
				d <= -0.02  ? '#fbd9c7' : //diminution
				d <= 0.02 ? '#f69564' : //stabilité
				'grey' ;
			}
		}
		
		function getColor2(a,d) { //N4_VAR_RRF
			if(a=="département") {
				return 	d > 0.0005 ? '#ff4c4c' : //augmentation
				d <= -0.0005  ? '#ffcccc' : //diminution
				d <= 0.0005 ? '#ff7878' : //stabilité
				'grey' ;
			}
			else {
				return 	d > 0.005 ? '#ff4c4c' : //augmentation
				d <= -0.005  ? '#ffcccc' : //diminution
				d <= 0.005 ? '#ff7878' : //stabilité
				'grey' ;
			}
		}
		
		commune = L.geoJSON(JS_todo, {
			filter: function(feature, layer) {return feature.properties.type == "commune";},
			style : {weight: 0.8, color: "#3e62a4", opacity: 1, fillOpacity: 1, fillColor:"#00bdce"},
			onEachFeature: function(feature, layer) {
					layer.bindTooltip(feature.properties.libgeo, {className: 'Tooltips'});
					layer.on('click', function(e) {
						popup(feature.properties);
						territoireCible(e.target._latlngs);
						preventDefault(e);
						})
					}
		});
		
		//Ajout de la légende sur la carte
		var legende1 = L.imageOverlay('img/legende_indicateur1.png', [[51.4, -5.4],[49.6, 0.16]], {zIndex : '1000'} );
		var legende2 = L.imageOverlay('img/legende_indicateur2.png', [[51.4, -5.4],[49.6, 0.16]], {zIndex : '1000'} );
		var legende1dep = L.imageOverlay('img/legende_indicateur1dep.png', [[51.4, -5.4],[49.6, 0.16]], {zIndex : '1000'} );
		var legende2dep = L.imageOverlay('img/legende_indicateur2dep.png', [[51.4, -5.4],[49.6, 0.16]], {zIndex : '1000'} );
		map.addLayer(legende1dep);
		
		//Niveau d'affichage des couches
		map.createPane('territoireCible');
		map.getPane('territoireCible').style.zIndex = 600;
		map.createPane('regions');
		map.getPane('regions').style.zIndex = 500;
		
		function style_indicateur1(feature) {
			return {
			fillColor: getColor1(feature.properties.type, feature.properties.N1_EVO1718),
			weight: 0.8,
			opacity: 1,
			color: 'white',
			//dashArray: '3',
			fillOpacity: 1
		};
		}
		
		function style_indicateur2(feature) {
			return {
			fillColor: getColor2(feature.properties.type, feature.properties.N4_VAR_RRF),
			weight: 0.8,
			opacity: 1,
			color: 'white',
			//dashArray: '3',
			fillOpacity: 1
		};
		}
		
		//Reglage double click
		var timer = 0;
		var delay = 200;
		var prevent = false;
		
		departement = L.geoJSON(JS_todo, {
			filter: function(feature, layer) {return feature.properties.type == "département";},
			style: style_indicateur1,
			onEachFeature: function(feature, layer) {
					layer.bindTooltip(feature.properties.libgeo, {className: 'Tooltips'});
					layer.on('click', function(e) {
						 //timer = setTimeout(function() {
							//if (!prevent) {
								popup(feature.properties);
								territoireCible(e.target._latlngs);
								e.preventDefault();
							//}
							//prevent = false;
							//}, delay);			
						});
					/*layer.on('dblclick', function(e) {
						clearTimeout(timer);
						prevent = true;
						//preventDefault(e);
						//territoireCible(e.target._latlngs);
						map.fitBounds(e.target._latlngs, { paddingTopLeft: [300, 0] });
						selectCom(e.target.feature.properties.codgeo, indicateur);
						e.preventDefault();
						});*/
					}
		}).addTo(map);
		
		epci = L.geoJSON(JS_todo, {
			filter: function(feature, layer) {return feature.properties.type == "epci";},
			style: style_indicateur1,
			onEachFeature: function(feature, layer) {
					layer.bindTooltip(feature.properties.libgeo, {className: 'Tooltips'});
					layer.on('click', function(e) {
						timer = setTimeout(function() {
							if (!prevent) {
								popup(feature.properties);
								territoireCible(e.target._latlngs);
							}
							prevent = false;
							}, delay);	
						})
					layer.on('dblclick', function(e) {
						clearTimeout(timer);
						prevent = true;
						map.fitBounds(e.target._latlngs, { paddingTopLeft: [300, 0] , maxZoom :10});
						selectCom(e.target.feature.properties.codgeo, indicateur);
						epciCible(e.target._latlngs);
						e.preventDefault();
						});
					}
		}).addTo(map);
		
		Contour_Regions = L.geoJSON(JS_todo, {
			filter: function(feature, layer) {return feature.properties.type == "région";},
			style: {interactive: false, color: "#ffffff", weight: 1.5, opacity: 1, pane:'territoireCible', fillOpacity: 0}
		}).addTo(map);
		
		//Ajout de la sidebar
		var sidebar = L.control.sidebar('sidebar').addTo(map);
		
		//Fonctions de formatage de nombres
		
		function format1(nombre){ //2 chiffres après la virgule
		  nombre=parseFloat(nombre).toFixed(2);
		  return nombre;
		}
		
		function format2(nombre){ //séparateurs de milliers
		  nombre += '';
		  var sep = '&nbsp;';
		  var reg = /(\d+)(\d{3})/;
		  while( reg.test( nombre)) {
			nombre = nombre.replace( reg, '$1' +sep +'$2');
		  }
		  return nombre;
		}
		
		function format3(nombre){ // pas de chiffre après la virgule
		  nombre=parseFloat(nombre).toFixed(0);
		  return nombre;
		}
		
		function format4(nombre){ // valeur absolue
		  nombre=parseFloat(nombre).toFixed(2);
		  return Math.abs(nombre);
		}
		
		//Action au clic sur un marker
		function popup(e) {
			
			if (document.getElementById('sidebar').classList.contains('collapsed')){
				sidebar.open('home');
				}
			
			//Remplissage de la popup
			document.getElementById('popup').style.display = "block";
			document.getElementById('defaut').style.display = "none";
			document.getElementById('onglet_departement').style.display = "none";
			document.getElementById('onglet_commune').style.display = "none";
			document.getElementById('onglet_epci').style.display = "none";
			document.getElementById('titre').innerHTML = "<h1 style='color:#f26664'>"+e.libgeo+"</h1><p>Les données concernant votre "+e.type+"</p>";
			document.getElementById('N1EVO').innerHTML = "<span>"+format1(e.N1_EVO1718*100)+"&nbsp;%</span>";
			document.getElementById('N2MONTANT').innerHTML = "<span>"+format2(e.N2_MONTANT)+"&nbsp;€</span>";
			document.getElementById('N2_DP').innerHTML = "<span>dont dotation de solidarité territoriale&nbsp;&nbsp;:&nbsp;"+format2(e.N2_DP)+"&nbsp;€</span></br>";
			document.getElementById('N6PCTRRF').innerHTML = "<span>"+format1(e.N6_PCTRRF*100)+"&nbsp;%</span>";
			document.getElementById('N3DGFHAB').innerHTML = "<span>"+format3(e.N3_DGFHAB)+"&nbsp;€</span>";
			document.getElementById('N4VARRRF').innerHTML = "<span>"+format1(e.N4_VAR_RRF*100)+"&nbsp;%</span>";
			if(e.N4_VAR_RRF > 0) {document.getElementById('N4info').innerHTML = "<span>L'augmentation de DGF représente "+format1(e.N4_VAR_RRF*100)+"% des RRF</span>";}
			if(e.N4_VAR_RRF <= 0) {document.getElementById('N4info').innerHTML = "<span>La diminution de DGF représente "+format4(e.N4_VAR_RRF*100)+"% des RRF</span>";}
			document.getElementById('N5PEREK').innerHTML = "<span>"+format1(e.N5_PEREK*100)+"&nbsp;%</span>";
			document.getElementById('lien').innerHTML = "<span><a href='http://www.dotations-dgcl.interieur.gouv.fr/consultation/dotation_commune_html.php?code="+e.codgeo+"' target='blank'>En savoir plus</a></span>";
		}
		
		//Indiquer territoire sélectionné
		var territoireCib; //lors d'un simple clic
		function territoireCible(e) {
			if(epciCib) {map.removeLayer(epciCib);}
			if(territoireCib) {map.removeLayer(territoireCib);}
			territoireCib = new L.polygon(e, {weight:3, color:"#ffee00",pane:'territoireCible', fillOpacity: 0});
			territoireCib.addTo(map);
		}
		
		var epciCib; //lorsqu'on affiche un ensemble de communes appartenant au même epci
		function epciCible(e) {
			if(territoireCib) {map.removeLayer(territoireCib);}
			if(epciCib) {map.removeLayer(epciCib);}
			epciCib = new L.polygon(e, {weight:3, color:"red",pane:'territoireCible', fillOpacity: 0, interactive:false});
			epciCib.addTo(map);
		}
		
		function clickMap () {
			if(territoireCib) {map.removeLayer(territoireCib);}
			if(com_select) {map.removeLayer(com_select);}
			//fermer ou ouvrir la sidebar
			if (document.getElementById('sidebar').classList.contains('collapsed')) {
				sidebar.open('home');
			}
			//else {
			//	sidebar.close();
			//}
			//remettre le texte d'intro
			document.getElementById('popup').style.display = "none";
			document.getElementById('defaut').style.display = "block";
			}
			
		//Events au clic sur la carte
		map.on('click', clickMap);
		
		//Event au clic sur "home"
		document.getElementById("logo").addEventListener("click", function(event){
			event.stopPropagation();
			retourAcceuil();
		});
		
		//Event au clic sur les onglets
		document.getElementById("logo_com").addEventListener("click", function(event){event.stopPropagation();showCom();;});
		document.getElementById("logo_epci").addEventListener("click", function(event){event.stopPropagation();showEpci();});
		document.getElementById("logo_dep").addEventListener("click", function(event){event.stopPropagation();showDep();});
		document.getElementById("indicateur1").addEventListener("click", function(event){
			event.stopPropagation();
			departement.setStyle(style_indicateur1);
			commune.setStyle(style_indicateur1);
			epci.setStyle(style_indicateur1);
			document.getElementById('indicateur1').className = "bouton_on";
			document.getElementById('indicateur2').className = "bouton"; 
			switchind("to2");
			switch_legende ("indicateur1", maillage)			
			});
		document.getElementById("indicateur2").addEventListener("click", function(event){
			event.stopPropagation(); 
			departement.setStyle(style_indicateur2);
			commune.setStyle(style_indicateur2);
			epci.setStyle(style_indicateur2);
			document.getElementById('indicateur2').className = "bouton_on";
			document.getElementById('indicateur1').className = "bouton"; 
			switchind("to1");
			switch_legende ("indicateur2", maillage)
			});
		
		//Changement d'indicateur dans une page de maillage
		
		
		var boutons_switch = document.getElementsByClassName("switch_indicateur");
		
		for (var i = 0; i < boutons_switch.length; i++) {
			boutons_switch[i].addEventListener('click', function(i){
				if(com_select) {map.removeLayer(com_select);}
				if (i.target.title == "indicateur1"){
					epci.setStyle(style_indicateur2);
					commune.setStyle(style_indicateur2);
					departement.setStyle(style_indicateur2);
					i.target.innerHTML = "<img src='img/fleche.png' style='vertical-align:middle; width:20px;padding:0px 10px;'>Voir la variation de la DGF entre 2018 et 2019";
					i.target.title = "indicateur2";
					indicateur = "indicateur2";
					switch_legende ("indicateur2", maillage)
				}
				else if (i.target.title == "indicateur2"){
					epci.setStyle(style_indicateur1);
					commune.setStyle(style_indicateur1);
					departement.setStyle(style_indicateur1);
					i.target.innerHTML = "<img src='img/fleche.png' style='vertical-align:middle; width:20px;padding:0px 10px;' />Voir la variation de la DGF entre 2018 et 2019 en pourcentage des recettes réelles de fonctionnement";
					i.target.title = "indicateur1";
					indicateur = "indicateur1";
					switch_legende ("indicateur1", maillage)
				};
			});
		}
		
		function switchind(ind) {
			if(com_select) {map.removeLayer(com_select);}
			if (ind=="to1"){
				for (var i = 0; i < boutons_switch.length; i++) {
					boutons_switch[i].innerHTML = "<img src='img/fleche.png' style='vertical-align:middle; width:20px;padding:0px 10px;'>Voir la variation de la DGF entre 2018 et 2019";
					boutons_switch[i].title = "indicateur2";
					indicateur = "indicateur2";
				}
			}
			else if (ind=="to2"){
				for (var i = 0; i < boutons_switch.length; i++) {
					boutons_switch[i].innerHTML = "<img src='img/fleche.png' style='vertical-align:middle; width:20px;padding:0px 10px;' />Voir la variation de la DGF entre 2018 et 2019 en pourcentage des recettes réelles de fonctionnement";
					boutons_switch[i].title = "indicateur1";
					indicateur = "indicateur1";
				}
			}
		}
		
		var boutons_com = document.getElementsByClassName("bouton_com");
		for (var i = 0; i < boutons_com.length; i++) {
			boutons_com[i].addEventListener('click', showCom, false);
		}
		
		var boutons_epci = document.getElementsByClassName("bouton_epci");
		for (var i = 0; i < boutons_epci.length; i++) {
			boutons_epci[i].addEventListener('click', showEpci, false);
		}
		
		var boutons_dep = document.getElementsByClassName("bouton_dep");
		for (var i = 0; i < boutons_dep.length; i++) {
			boutons_dep[i].addEventListener('click', showDep, false);
		}
		
		//Event au clic sur "retour"
		var boutons_retour = document.getElementsByClassName("retour");
		for (var i = 0; i < boutons_retour.length; i++) {
			boutons_retour[i].addEventListener('click', retourAcceuil, false);
		}
			
		//Event au clic sur la barre verticale
		document.getElementById("barre-verticale").addEventListener("click", function(event){
			
			if (document.getElementById('sidebar').classList.contains('collapsed')) {
				sidebar.open('home');
			}
			else {
				sidebar.close();
			}
		});
		
		//Barre de recherche
		var Recherche = L.layerGroup([commune]);
		
		var searchControl = new L.control.search({
			layer: Recherche,
			initial: false,
			//position:'topright',
			propertyName: 'libgeo',
			marker: false,
			moveToLocation: function(latlng, title, map) {
				var zoom = map.getBoundsZoom(latlng.layer.getBounds());
				map.setView(latlng, zoom-1);
			}
		})
		
		searchControl.on('search:locationfound', function(e) {
			if(territoireCib) {map.removeLayer(territoireCib);}
			popup(e.layer.feature.properties);
			selectCom(e.layer.feature.properties.ID_EPCI, indicateur);
			territoireCible(e.layer._latlngs);
		});
		
		var searchControl2 = new L.control.search({
			layer: Recherche,
			initial: false,
			position:'topright',
			propertyName: 'libgeo',
			collapsed: true,
			marker: false,
			moveToLocation: function(latlng, title, map) {
				var zoom = map.getBoundsZoom(latlng.layer.getBounds());
				map.setView(latlng, zoom-1);
			}
		})
		
		searchControl2.on('search:locationfound', function(e) {
			if(territoireCib) {map.removeLayer(territoireCib);}
			popup(e.layer.feature.properties);
			selectCom(e.layer.feature.properties.ID_EPCI,indicateur);
			territoireCible(e.layer._latlngs);
		});
		
		map.addControl(searchControl2);
		map.addControl(searchControl);
		
		// déplacement du controle de recherche
		var htmlObject = searchControl.getContainer();
		var a = document.getElementById('boiteRecherche');
		function setParent(el, newParent)
		{newParent.appendChild(el);}
		setParent(htmlObject, a);
		
		
		sidebar.open('home');
		
		map.removeLayer(commune);
		map.removeLayer(epci);
		
		//Fonctions 
		
		function retourAcceuil () {
			resetView();
			sidebar.open('home');
			if(com_select) {map.removeLayer(com_select);}
			//remettre le texte d'intro
			document.getElementById('popup').style.display = "none";
			document.getElementById('defaut').style.display = "block";
			document.getElementById('onglet_departement').style.display = "none";
			document.getElementById('onglet_commune').style.display = "none";
			document.getElementById('onglet_epci').style.display = "none";
			document.getElementById('logo_epci').setAttribute("class", "onglets");
			document.getElementById('logo_dep').setAttribute("class", "onglets");
			document.getElementById('logo_com').setAttribute("class", "onglets");
			//event.stopPropagation();
		}
		
		function resetView() {
			map.setView([46.5, -1.8], 6);		
		}

		function showDep() {
			//event.stopPropagation();
			resetView();
			sidebar.open('home');
			if(territoireCib) {map.removeLayer(territoireCib);}
			if(com_select) {map.removeLayer(com_select);}
			maillage = "département";
			switch_legende (indicateur, maillage);
			document.getElementById('popup').style.display = "none";
			document.getElementById('defaut').style.display = "none";
			document.getElementById('onglet_departement').style.display = "block";
			document.getElementById('onglet_commune').style.display = "none";
			document.getElementById('onglet_epci').style.display = "none";
			document.getElementById('logo_dep').setAttribute("class", "onglets_on");
			document.getElementById('logo_epci').setAttribute("class", "onglets");
			document.getElementById('logo_com').setAttribute("class", "onglets");
			map.removeLayer(epci);
			map.addLayer(departement);
		}
		
		function showEpci() {
			//event.stopPropagation();
			resetView();
			sidebar.open('home');
			if(territoireCib) {map.removeLayer(territoireCib);}
			if(com_select) {map.removeLayer(com_select);}
			maillage = "epci";
			switch_legende (indicateur, maillage);
			document.getElementById('popup').style.display = "none";
			document.getElementById('defaut').style.display = "none";
			document.getElementById('onglet_departement').style.display = "none";
			document.getElementById('onglet_commune').style.display = "none";
			document.getElementById('onglet_epci').style.display = "block";
			document.getElementById('logo_epci').setAttribute("class", "onglets_on");
			document.getElementById('logo_dep').setAttribute("class", "onglets");
			document.getElementById('logo_com').setAttribute("class", "onglets");
			map.removeLayer(departement);
			map.addLayer(epci);
		}
		
		function showCom() {
			//event.stopPropagation();
			resetView();
			sidebar.open('home');
			if(territoireCib) {map.removeLayer(territoireCib);}
			if(com_select) {map.removeLayer(com_select);}
			maillage = "commune";
			switch_legende (indicateur, maillage);
			document.getElementById('popup').style.display = "none";
			document.getElementById('defaut').style.display = "none";
			document.getElementById('onglet_departement').style.display = "none";
			document.getElementById('onglet_commune').style.display = "block";
			document.getElementById('onglet_epci').style.display = "none";
			document.getElementById('logo_com').setAttribute("class", "onglets_on");
			document.getElementById('logo_dep').setAttribute("class", "onglets");
			document.getElementById('logo_epci').setAttribute("class", "onglets");	
		}
		
		var com_select;
		
		function selectCom(epci_cible,indicateur) {
		if(territoireCib) {map.removeLayer(territoireCib);}
		if(com_select) {map.removeLayer(com_select);}
		if(departement) map.removeLayer(departement);
		map.addLayer(epci);
		if (indicateur == "indicateur1"){
		com_select = L.geoJSON(JS_todo, {
			filter: function(feature, layer) {return  feature.properties.ID_EPCI == epci_cible && feature.properties.type == "commune"; },
			style : style_indicateur1,
			onEachFeature: function(feature, layer) {
				layer.bindTooltip(feature.properties.libgeo, {className: 'Tooltips'});
				layer.on('click', function(e) {
					popup(feature.properties);
					territoireCible(e.target._latlngs);
					preventDefault(e);
				})
				}
		});
		}
		else if (indicateur == "indicateur2"){
		com_select = L.geoJSON(JS_todo, {
			filter: function(feature, layer) {return  feature.properties.ID_EPCI == epci_cible && feature.properties.type == "commune"; },
			style : style_indicateur2,
			onEachFeature: function(feature, layer) {
				layer.bindTooltip(feature.properties.libgeo, {className: 'Tooltips'});
				layer.on('click', function(e) {
					popup(feature.properties);
					territoireCible(e.target._latlngs);
					preventDefault(e);
				})
				}
		});
		}
		map.addLayer(com_select);
		}
		
		function switch_legende (indicateur, niveau) {
			if (indicateur === "indicateur1") {
				if (niveau=="département"){map.addLayer(legende1dep);if(legende2){map.removeLayer(legende2)};if(legende1){map.removeLayer(legende1)};if(legende2dep){map.removeLayer(legende2dep)};}
				else {map.addLayer(legende1);if(legende2){map.removeLayer(legende2)};if(legende1dep){map.removeLayer(legende1dep)};if(legende2dep){map.removeLayer(legende2dep)};}
			}
			else if (indicateur== "indicateur2") {
				if (niveau=="département"){map.addLayer(legende2dep);if(legende1){map.removeLayer(legende1)};if(legende1dep){map.removeLayer(legende1dep)};if(legende2){map.removeLayer(legende2)};}
				else {map.addLayer(legende2);if(legende1){map.removeLayer(legende1)};if(legende1dep){map.removeLayer(legende1dep)};if(legende2dep){map.removeLayer(legende2dep)};}
			}
		}
		
		
   </script>
	
</body>



</html>
